.PHONY: build up down logs test clean help simulator-logs sync-logs dovecot-logs status restart
.PHONY: all-up all-down all-status proxy-up proxy-down dsl-up dsl-down e2e-test up-detached

# DomyÅ›lny cel
help:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  e-DorÄ™czenia Middleware Sync"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Komendy lokalne (ten projekt):"
	@echo "  make build      - Buduje obrazy Docker"
	@echo "  make up         - Uruchamia kontenery sync"
	@echo "  make down       - Zatrzymuje kontenery sync"
	@echo "  make logs       - Logi wszystkich kontenerÃ³w"
	@echo "  make test       - Uruchamia testy jednostkowe"
	@echo "  make status     - Status kontenerÃ³w"
	@echo "  make clean      - CzyÅ›ci zasoby Docker"
	@echo "  make sync-once  - Jednorazowa synchronizacja"
	@echo ""
	@echo "Komendy wszystkich usÅ‚ug:"
	@echo "  make all-up     - Uruchamia WSZYSTKIE usÅ‚ugi (proxy + sync + dsl)"
	@echo "  make all-down   - Zatrzymuje WSZYSTKIE usÅ‚ugi"
	@echo "  make all-status - Status wszystkich usÅ‚ug"
	@echo "  make e2e-test   - Testy E2E caÅ‚ego systemu"
	@echo ""
	@echo "Komendy innych usÅ‚ug:"
	@echo "  make proxy-up   - Uruchamia proxy IMAP/SMTP"
	@echo "  make proxy-down - Zatrzymuje proxy IMAP/SMTP"
	@echo "  make dsl-up     - Uruchamia DSL"
	@echo "  make dsl-down   - Zatrzymuje DSL"
	@echo ""
	@echo "Logi poszczegÃ³lnych serwisÃ³w:"
	@echo "  make simulator-logs  - Logi symulatora API"
	@echo "  make sync-logs       - Logi middleware sync"
	@echo "  make dovecot-logs    - Logi serwera IMAP"
	@echo ""
	@echo "Dane dostÄ™powe (Sync):"
	@echo "  Webmail:     http://localhost:9180"
	@echo "  API Docs:    http://localhost:8280/docs"
	@echo "  IMAP:        localhost:21143"
	@echo "  User/Pass:   mailuser / mailpass123"

# Budowanie obrazÃ³w
build:
	docker-compose build

# Uruchomienie
up:
	docker-compose up --build
	@echo ""
	@echo "=== Serwisy uruchomione ==="
	@echo "Webmail:     http://localhost:9180"
	@echo "API Docs:    http://localhost:8280/docs"
	@echo "IMAP:        localhost:21143"
	@echo "User/Pass:   mailuser / mailpass123"
	@echo ""
	@echo "Synchronizacja uruchomi siÄ™ automatycznie co minutÄ™."

# Zatrzymanie
down:
	docker-compose down

# Logi wszystkich serwisÃ³w
logs:
	docker-compose logs -f

# Logi symulatora
simulator-logs:
	docker-compose logs -f edoreczenia-simulator

# Logi sync
sync-logs:
	docker-compose logs -f edoreczenia-sync

# Logi Dovecot
dovecot-logs:
	docker-compose logs -f dovecot

# Jednorazowa synchronizacja
sync-once:
	docker-compose exec edoreczenia-sync python -m edoreczenia_sync.main --once

# Status synchronizacji
sync-status:
	docker-compose exec edoreczenia-sync python -m edoreczenia_sync.main --status

# Uruchomienie testÃ³w
test:
	docker-compose --profile test up --build --abort-on-container-exit tests

# Debug mode z adminerem
debug:
	docker-compose --profile debug up -d
	@echo "Adminer dostÄ™pny: http://localhost:9001"

# Czyszczenie
clean:
	docker-compose down -v --rmi local
	docker system prune -f

# Restart
restart: down up

# Status
status:
	docker-compose ps

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KOMENDY WSZYSTKICH USÅUG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Uruchom wszystkie usÅ‚ugi
all-up:
	@echo "ğŸš€ Uruchamianie wszystkich usÅ‚ug e-DorÄ™czeÅ„..."
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp up-detached
	docker-compose up -d --build
	@$(MAKE) -C ../edoreczenia-dsl up-detached
	@echo ""
	@echo "âœ… Wszystkie usÅ‚ugi uruchomione!"
	@$(MAKE) all-status

# Zatrzymaj wszystkie usÅ‚ugi
all-down:
	@echo "ğŸ›‘ Zatrzymywanie wszystkich usÅ‚ug e-DorÄ™czeÅ„..."
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp down
	docker-compose down
	@$(MAKE) -C ../edoreczenia-dsl down
	@echo "âœ… Wszystkie usÅ‚ugi zatrzymane"

# Status wszystkich usÅ‚ug
all-status:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  STATUS WSZYSTKICH USÅUG e-DorÄ™czeÅ„"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“¦ PROXY IMAP/SMTP (localhost:8180, :11143, :11025, :9080):"
	@docker-compose -f ../edoreczenia-proxy-imap-smtp/docker-compose.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (nie uruchomiony)"
	@echo ""
	@echo "ğŸ“¦ MIDDLEWARE SYNC (localhost:8280, :21143, :9180):"
	@docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (nie uruchomiony)"
	@echo ""
	@echo "ğŸ“¦ DSL (localhost:8380, :31143, :31025):"
	@docker-compose -f ../edoreczenia-dsl/docker-compose.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (nie uruchomiony)"

# Testy E2E caÅ‚ego systemu
e2e-test:
	@echo "ğŸ§ª Uruchamianie testÃ³w E2E..."
	@python3 ../test_e2e.py

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KOMENDY INNYCH USÅUG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Proxy IMAP/SMTP
proxy-up:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp up

proxy-down:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp down

proxy-logs:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp logs

proxy-status:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp status

# DSL
dsl-up:
	@$(MAKE) -C ../edoreczenia-dsl up

dsl-down:
	@$(MAKE) -C ../edoreczenia-dsl down

dsl-logs:
	@$(MAKE) -C ../edoreczenia-dsl logs

dsl-test:
	@$(MAKE) -C ../edoreczenia-dsl test

dsl-status:
	@$(MAKE) -C ../edoreczenia-dsl status

# Uruchomienie w tle (dla all-up)
up-detached:
	docker-compose up -d --build
