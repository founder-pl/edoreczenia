version: '3.8'

services:
  # ===========================================
  # Nextcloud - Cloud Storage for Szyfromat.pl
  # ===========================================
  nextcloud:
    image: nextcloud:28-apache
    container_name: szyfromat-nextcloud
    ports:
      - "${NEXTCLOUD_PORT:-8080}:80"
    environment:
      NEXTCLOUD_ADMIN_USER: ${NEXTCLOUD_ADMIN_USER:-admin}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD:-admin}
      NEXTCLOUD_TRUSTED_DOMAINS: "localhost ${NEXTCLOUD_DOMAIN:-nextcloud.szyfromat.pl}"
      MYSQL_HOST: nextcloud-db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-nextcloud_secret}
      # Szyfromat.pl integration
      SZYFROMAT_API_URL: ${SZYFROMAT_API_URL:-http://host.docker.internal:8500}
    volumes:
      - nextcloud_data:/var/www/html
      - nextcloud_apps:/var/www/html/custom_apps
      - ./config/config.php:/var/www/html/config/szyfromat.config.php:ro
    depends_on:
      - nextcloud-db
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - nextcloud-net
    restart: unless-stopped

  # ===========================================
  # MariaDB - Database for Nextcloud
  # ===========================================
  nextcloud-db:
    image: mariadb:10.11
    container_name: szyfromat-nextcloud-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_secret}
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-nextcloud_secret}
    volumes:
      - nextcloud_db:/var/lib/mysql
    networks:
      - nextcloud-net
    restart: unless-stopped

  # ===========================================
  # Szyfromat Sync Service
  # ===========================================
  szyfromat-sync:
    build:
      context: ./sync
      dockerfile: Dockerfile
    container_name: szyfromat-nextcloud-sync
    environment:
      NEXTCLOUD_URL: http://nextcloud
      NEXTCLOUD_USER: ${NEXTCLOUD_ADMIN_USER:-admin}
      NEXTCLOUD_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD:-admin}
      SZYFROMAT_API_URL: ${SZYFROMAT_API_URL:-http://host.docker.internal:8500}
      SYNC_INTERVAL: ${SYNC_INTERVAL:-300}
    depends_on:
      - nextcloud
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - nextcloud-net
    restart: unless-stopped

volumes:
  nextcloud_data:
  nextcloud_apps:
  nextcloud_db:

networks:
  nextcloud-net:
    driver: bridge
