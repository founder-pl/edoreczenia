.PHONY: build up down logs test clean help status dev install

# ZaÅ‚aduj zmienne z .env
include .env
export

# DomyÅ›lne wartoÅ›ci (jeÅ›li nie ma w .env)
BACKEND_PORT ?= 4000
FRONTEND_PORT ?= 4100
IDCARD_DOMAIN ?= localhost
DEMO_USER_EMAIL ?= demo@idcard.pl
DEMO_USER_PASSWORD ?= demo123

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# POMOC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

help:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  IDCard.pl - Gateway Integracji UsÅ‚ug Cyfrowych"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Komendy developerskie:"
	@echo "  make install      - Instaluje zaleÅ¼noÅ›ci"
	@echo "  make dev          - Uruchamia w trybie developerskim"
	@echo "  make dev-backend  - Uruchamia tylko backend"
	@echo "  make dev-frontend - Uruchamia tylko frontend"
	@echo ""
	@echo "Komendy Docker:"
	@echo "  make build        - Buduje obrazy Docker"
	@echo "  make up           - Uruchamia kontenery"
	@echo "  make down         - Zatrzymuje kontenery"
	@echo "  make logs         - Pokazuje logi"
	@echo "  make status       - Status kontenerÃ³w"
	@echo "  make clean        - CzyÅ›ci zasoby Docker"
	@echo ""
	@echo "Testy:"
	@echo "  make test         - Uruchamia testy"
	@echo "  make test-api     - Testuje API"
	@echo ""
	@echo "CLI:"
	@echo "  make cli-login    - Zaloguj siÄ™"
	@echo "  make cli-register - Zarejestruj uÅ¼ytkownika"
	@echo "  make cli-connect  - PoÅ‚Ä…cz usÅ‚ugÄ™"
	@echo "  make cli-inbox    - PokaÅ¼ skrzynkÄ™"
	@echo ""
	@echo "DostÄ™p:"
	@echo "  Frontend:  http://$(IDCARD_DOMAIN):$(FRONTEND_PORT)"
	@echo "  API:       http://$(IDCARD_DOMAIN):$(BACKEND_PORT)"
	@echo "  API Docs:  http://$(IDCARD_DOMAIN):$(BACKEND_PORT)/docs"
	@echo ""
	@echo "Demo konto:"
	@echo "  Email:    $(DEMO_USER_EMAIL)"
	@echo "  HasÅ‚o:    $(DEMO_USER_PASSWORD)"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INSTALACJA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

install:
	@echo "ğŸ“¦ Instalacja zaleÅ¼noÅ›ci..."
	cd frontend && npm install
	cd backend && pip install -r requirements.txt
	@echo "âœ… ZaleÅ¼noÅ›ci zainstalowane"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEVELOPMENT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

dev:
	@echo "ğŸš€ Uruchamianie w trybie developerskim..."
	@echo "Backend: http://$(IDCARD_DOMAIN):$(BACKEND_PORT)"
	@echo "Frontend: http://$(IDCARD_DOMAIN):$(FRONTEND_PORT)"
	@make -j2 dev-backend dev-frontend

dev-backend:
	cd backend && uvicorn app.main:app --reload --host 0.0.0.0 --port $(BACKEND_PORT)

dev-frontend:
	cd frontend && npm run dev -- --port $(FRONTEND_PORT)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DOCKER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

build:
	docker-compose build

up:
	docker-compose up --build -d
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  IDCard.pl uruchomiony!"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  Frontend:  http://$(IDCARD_DOMAIN):$(FRONTEND_PORT)"
	@echo "  API:       http://$(IDCARD_DOMAIN):$(BACKEND_PORT)"
	@echo "  API Docs:  http://$(IDCARD_DOMAIN):$(BACKEND_PORT)/docs"
	@echo ""
	@echo "  Demo:      $(DEMO_USER_EMAIL) / $(DEMO_USER_PASSWORD)"
	@echo ""

down:
	docker-compose down

logs:
	docker-compose logs -f

status:
	@echo "Status kontenerÃ³w IDCard.pl:"
	@docker-compose ps

clean:
	docker-compose down -v --rmi local
	@echo "âœ… Zasoby Docker wyczyszczone"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TESTY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test:
	@echo "ğŸ§ª Uruchamianie testÃ³w..."
	cd backend && python -m pytest tests/ -v

test-api:
	@echo "ğŸ§ª Testowanie API..."
	@echo ""
	@echo "1. Health check:"
	@curl -s http://$(IDCARD_DOMAIN):$(BACKEND_PORT)/health | python3 -m json.tool
	@echo ""
	@echo "2. Login (demo):"
	@curl -s -X POST http://$(IDCARD_DOMAIN):$(BACKEND_PORT)/api/auth/login \
		-H "Content-Type: application/json" \
		-d '{"email":"$(DEMO_USER_EMAIL)","password":"$(DEMO_USER_PASSWORD)"}' | python3 -m json.tool
	@echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CLI
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cli-login:
	@./cli/idcard login -u $(DEMO_USER_EMAIL) -p $(DEMO_USER_PASSWORD)

cli-register:
	@./cli/idcard register

cli-connect:
	@./cli/idcard connect

cli-inbox:
	@./cli/idcard inbox

cli-status:
	@./cli/idcard status
