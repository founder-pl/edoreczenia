.PHONY: build up down logs test test-scenarios test-client clean help send receive sync show-report list-reports status restart
.PHONY: all-up all-down all-status proxy-up proxy-down sync-up sync-down e2e-test up-detached

# DomyÅ›lny cel
help:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  e-DorÄ™czenia DSL - Apache Camel + Groovy + Python"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Komendy lokalne (ten projekt):"
	@echo "  make build      - Buduje obrazy Docker"
	@echo "  make up         - Uruchamia kontenery DSL"
	@echo "  make down       - Zatrzymuje kontenery DSL"
	@echo "  make logs       - Logi wszystkich kontenerÃ³w"
	@echo "  make status     - Status kontenerÃ³w"
	@echo "  make clean      - CzyÅ›ci zasoby Docker"
	@echo ""
	@echo "Komendy wszystkich usÅ‚ug:"
	@echo "  make all-up     - Uruchamia WSZYSTKIE usÅ‚ugi (proxy + sync + dsl)"
	@echo "  make all-down   - Zatrzymuje WSZYSTKIE usÅ‚ugi"
	@echo "  make all-status - Status wszystkich usÅ‚ug"
	@echo "  make e2e-test   - Testy E2E caÅ‚ego systemu"
	@echo ""
	@echo "Komendy innych usÅ‚ug:"
	@echo "  make proxy-up   - Uruchamia proxy IMAP/SMTP"
	@echo "  make proxy-down - Zatrzymuje proxy IMAP/SMTP"
	@echo "  make sync-up    - Uruchamia middleware-sync"
	@echo "  make sync-down  - Zatrzymuje middleware-sync"
	@echo ""
	@echo "Komendy testowe DSL:"
	@echo "  make test           - Szybki test DSL"
	@echo "  make test-scenarios - PeÅ‚ne testy scenariuszowe (raporty MD)"
	@echo "  make send           - WysyÅ‚a testowÄ… wiadomoÅ›Ä‡"
	@echo "  make receive        - Odbiera wiadomoÅ›ci"
	@echo ""
	@echo "Raporty Markdown:"
	@echo "  make show-report    - WyÅ›wietl ostatni raport"
	@echo "  make list-reports   - Lista wszystkich raportÃ³w"
	@echo ""
	@echo "Dane dostÄ™powe (DSL - unikalne porty):"
	@echo "  Symulator:   http://localhost:8380/docs"
	@echo "  IMAP:        localhost:31143 (mailuser/mailpass123)"
	@echo "  SMTP Proxy:  localhost:31025 (testuser/testpass123)"
	@echo "  Raporty:     ./logs/*.md"

# Budowanie
build:
	docker-compose build

# Uruchomienie
up:
	docker-compose up --build
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  e-DorÄ™czenia DSL uruchomiony"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  DSL API:     http://localhost:8090"
	@echo "  Symulator:   http://localhost:8180/docs"
	@echo ""
	@echo "  PrzykÅ‚ad wysyÅ‚ania:"
	@echo "    curl -X POST http://localhost:8090/api/v1/messages \\"
	@echo "      -H 'Content-Type: application/json' \\"
	@echo "      -d '{\"subject\":\"Test\",\"recipient\":\"AE:PL-...\",\"content\":\"TreÅ›Ä‡\"}'"

# Zatrzymanie
down:
	docker-compose down

# Logi
logs:
	docker-compose logs -f

# Logi DSL
dsl-logs:
	docker-compose logs -f edoreczenia-dsl

# Czyszczenie
clean:
	docker-compose down -v --rmi local
	rm -rf build/

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KOMENDY DSL (uÅ¼ywajÄ… Python Client)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# WysyÅ‚anie testowej wiadomoÅ›ci
send:
	@echo "ğŸ“¤ WysyÅ‚anie testowej wiadomoÅ›ci..."
	@python3 -c "from python_client.client import EDoreczeniaClient; from python_client.logger import MarkdownLogger; \
		c = EDoreczeniaClient(logger=MarkdownLogger(scenario_name='send')); \
		c.authenticate(); \
		r = c.send_message('AE:PL-ODBIORCA-TEST-00001', 'Test DSL', 'WiadomoÅ›Ä‡ testowa z DSL'); \
		print(f'âœ… WysÅ‚ano: {r.get(\"messageId\")} [{r.get(\"status\")}]')"

# Odbieranie wiadomoÅ›ci
receive:
	@echo "ğŸ“¥ Odbieranie wiadomoÅ›ci..."
	@python3 -c "from python_client.client import EDoreczeniaClient; from python_client.logger import MarkdownLogger; \
		c = EDoreczeniaClient(logger=MarkdownLogger(scenario_name='receive')); \
		c.authenticate(); \
		msgs = c.get_messages('inbox', 10); \
		print(f'ğŸ“§ Pobrano {len(msgs)} wiadomoÅ›ci:'); \
		[print(f'   â€¢ {m.get(\"subject\", \"(brak)\")} [{m.get(\"status\")}]') for m in msgs[:5]]"

# Synchronizacja (info)
sync:
	@echo "ğŸ”„ Synchronizacja API â†’ IMAP..."
	@echo "UÅ¼yj: make test-scenarios dla peÅ‚nej synchronizacji z logami"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SKRYPTY GROOVY (lokalne)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# WysyÅ‚anie dokumentu (Groovy)
send-doc:
	@echo "UÅ¼ycie: groovy routes/send-document.groovy -f PLIK -r ODBIORCA"
	@echo "PrzykÅ‚ad: groovy routes/send-document.groovy -f dokument.pdf -r AE:PL-ODBIORCA-00001"

# Odbieranie (Groovy)
receive-groovy:
	groovy routes/receive-messages.groovy -f inbox -l 10

# Test poÅ‚Ä…czenia
test:
	@echo "ğŸ§ª Test poÅ‚Ä…czenia z API (port 8380)..."
	@curl -s http://localhost:8380/health | python3 -m json.tool || echo "âŒ Symulator DSL nie jest uruchomiony. UÅ¼yj: make up"
	@echo ""
	@echo "ğŸ§ª Test DSL..."
	@python3 routes/test-dsl.py

# PeÅ‚ne testy scenariuszowe z logami Markdown
test-scenarios:
	@echo "ğŸ§ª Uruchamianie scenariuszy testowych..."
	@python3 python_client/run_tests.py

# Szybki test Python Client
test-client:
	@python3 -c "from python_client.client import EDoreczeniaClient; c = EDoreczeniaClient(); print('âœ“ Client OK'); c.health_check()"

# WyÅ›wietl ostatni raport
show-report:
	@echo "ğŸ“„ Ostatni raport:"
	@ls -t logs/*.md 2>/dev/null | head -1 | xargs cat || echo "Brak raportÃ³w w logs/"

# Lista raportÃ³w
list-reports:
	@echo "ğŸ“‹ Raporty w logs/:"
	@ls -la logs/*.md 2>/dev/null || echo "Brak raportÃ³w"

# Status
status:
	docker-compose ps

# Restart
restart: down up

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KOMENDY WSZYSTKICH USÅUG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Uruchom wszystkie usÅ‚ugi
all-up:
	@echo "ğŸš€ Uruchamianie wszystkich usÅ‚ug e-DorÄ™czeÅ„..."
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp up-detached
	@$(MAKE) -C ../edoreczenia-middleware-sync up-detached
	docker-compose up -d --build
	@echo ""
	@echo "âœ… Wszystkie usÅ‚ugi uruchomione!"
	@$(MAKE) all-status

# Zatrzymaj wszystkie usÅ‚ugi
all-down:
	@echo "ğŸ›‘ Zatrzymywanie wszystkich usÅ‚ug e-DorÄ™czeÅ„..."
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp down
	@$(MAKE) -C ../edoreczenia-middleware-sync down
	docker-compose down
	@echo "âœ… Wszystkie usÅ‚ugi zatrzymane"

# Status wszystkich usÅ‚ug
all-status:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  STATUS WSZYSTKICH USÅUG e-DorÄ™czeÅ„"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“¦ PROXY IMAP/SMTP (localhost:8180, :11143, :11025, :9080):"
	@docker-compose -f ../edoreczenia-proxy-imap-smtp/docker-compose.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (nie uruchomiony)"
	@echo ""
	@echo "ğŸ“¦ MIDDLEWARE SYNC (localhost:8280, :21143, :9180):"
	@docker-compose -f ../edoreczenia-middleware-sync/docker-compose.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (nie uruchomiony)"
	@echo ""
	@echo "ğŸ“¦ DSL (localhost:8380, :31143, :31025):"
	@docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || echo "  (nie uruchomiony)"

# Testy E2E caÅ‚ego systemu
e2e-test:
	@echo "ğŸ§ª Uruchamianie testÃ³w E2E..."
	@python3 ../test_e2e.py

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# KOMENDY INNYCH USÅUG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Proxy IMAP/SMTP
proxy-up:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp up

proxy-down:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp down

proxy-logs:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp logs

proxy-status:
	@$(MAKE) -C ../edoreczenia-proxy-imap-smtp status

# Middleware Sync
sync-up:
	@$(MAKE) -C ../edoreczenia-middleware-sync up

sync-down:
	@$(MAKE) -C ../edoreczenia-middleware-sync down

sync-logs:
	@$(MAKE) -C ../edoreczenia-middleware-sync logs

sync-status:
	@$(MAKE) -C ../edoreczenia-middleware-sync status

# Uruchomienie w tle (dla all-up)
up-detached:
	docker-compose up -d --build
