services:
  # ===========================================
  # Symulator API e-Doręczeń (DSL)
  # Port 8380 - unikalny dla DSL
  # ===========================================
  edoreczenia-dsl-simulator:
    build:
      context: ../edoreczenia-proxy-imap-smtp/simulator
      dockerfile: Dockerfile
    container_name: edoreczenia-dsl-simulator
    ports:
      - "${SIMULATOR_PORT:-8380}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edoreczenia-dsl-net
    restart: unless-stopped

  # ===========================================
  # Dovecot IMAP (DSL)
  # Port 31143 - unikalny dla DSL
  # ===========================================
  edoreczenia-dsl-dovecot:
    build:
      context: ../edoreczenia-middleware-sync/dovecot
      dockerfile: Dockerfile
    container_name: edoreczenia-dsl-dovecot
    ports:
      - "${DOVECOT_PORT:-31143}:143"
    volumes:
      - dsl-maildir-data:/home/mailuser/Maildir
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "143"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - edoreczenia-dsl-net
    restart: unless-stopped

  # ===========================================
  # Proxy IMAP/SMTP (DSL)
  # Porty 31025/31026 - unikalne dla DSL
  # ===========================================
  edoreczenia-dsl-proxy:
    build:
      context: ../edoreczenia-proxy-imap-smtp
      dockerfile: Dockerfile
    container_name: edoreczenia-dsl-proxy
    ports:
      - "${PROXY_IMAP_PORT:-31025}:1143"
      - "${PROXY_SMTP_PORT:-31026}:1025"
    environment:
      EDORECZENIA_TOKEN_URL: http://edoreczenia-dsl-simulator:8080/oauth/token
      EDORECZENIA_API_BASE_URL: http://edoreczenia-dsl-simulator:8080/ua/v5
      EDORECZENIA_CLIENT_ID: ${EDORECZENIA_CLIENT_ID:-test_client_id}
      EDORECZENIA_CLIENT_SECRET: ${EDORECZENIA_CLIENT_SECRET:-test_client_secret}
      EDORECZENIA_ADDRESS: ${EDORECZENIA_ADDRESS:-AE:PL-12345-67890-ABCDE-12}
      LOCAL_AUTH_USERNAME: ${SMTP_USER:-testuser}
      LOCAL_AUTH_PASSWORD: ${SMTP_PASSWORD:-testpass123}
    depends_on:
      edoreczenia-dsl-simulator:
        condition: service_healthy
    networks:
      - edoreczenia-dsl-net
    restart: unless-stopped

networks:
  edoreczenia-dsl-net:
    driver: bridge

volumes:
  dsl-maildir-data:
